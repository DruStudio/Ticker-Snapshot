<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker Snapshot</title>
    <link rel="preconnect" href="https://api.coingecko.com">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#0a0a0f;--bg2:#15151f;--bg3:#1a1a28;--text:#fff;--text2:#a0a0b0;
            --accent:#5b7cff;--accent2:#4a6aee;--green:#22c55e;--red:#ef4444;--border:#2a2a3a;
            --glow:rgba(91,124,255,0.15);
        }
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;padding:16px;background-image:radial-gradient(circle at 20% 50%,rgba(91,124,255,0.05) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(139,92,246,0.05) 0%,transparent 50%)}
        header{text-align:center;margin-bottom:32px;padding:32px 16px 16px}
        h1{font-size:2.5rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#5b7cff 0%,#8b5cf6 50%,#ec4899 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.02em;animation:fadeInDown 0.8s ease-out}
        .subtitle{color:var(--text2);font-size:1.1rem;animation:fadeIn 1s ease-out 0.2s backwards}
        @keyframes fadeInDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
        .carousel-container{max-width:1200px;margin:0 auto 48px;animation:fadeIn 1.2s ease-out 0.4s backwards}
        .carousel-wrapper{display:flex;gap:20px;overflow-x:auto;scroll-behavior:smooth;padding:16px 8px 24px;scrollbar-width:thin;scrollbar-color:var(--accent) transparent;scroll-snap-type:x mandatory}
        .carousel-wrapper::-webkit-scrollbar{height:8px}
        .carousel-wrapper::-webkit-scrollbar-track{background:transparent}
        .carousel-wrapper::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}
        .carousel-item{min-width:260px;max-width:260px;flex-shrink:0;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);scroll-snap-align:start;animation:slideIn 0.6s ease-out backwards}
        .carousel-item:nth-child(1){animation-delay:0.5s}
        .carousel-item:nth-child(2){animation-delay:0.6s}
        .carousel-item:nth-child(3){animation-delay:0.7s}
        .carousel-item:nth-child(4){animation-delay:0.8s}
        .carousel-item:hover{transform:translateY(-8px) scale(1.02);filter:brightness(1.1)}
        .carousel-widget{width:260px;height:260px;background:linear-gradient(135deg,var(--bg3) 0%,#252538 100%);border-radius:16px;padding:24px;display:flex;flex-direction:column;justify-content:space-between;border:1px solid var(--border);box-shadow:0 8px 32px rgba(0,0,0,.4),0 0 0 1px rgba(91,124,255,0.1);position:relative;overflow:hidden;transition:all 0.3s}
        .carousel-item:hover .carousel-widget{border-color:var(--accent);box-shadow:0 12px 48px rgba(0,0,0,.5),0 0 0 1px var(--accent),0 0 20px var(--glow)}
        .carousel-widget::before{content:'';position:absolute;top:0;left:0;right:0;height:60%;background:radial-gradient(circle at 50% 0%,rgba(91,124,255,.08) 0%,transparent 70%);pointer-events:none}
        .widget-header{position:relative;z-index:1}
        .asset-name{font-size:1rem;font-weight:700;margin-bottom:3px;color:var(--text);letter-spacing:-0.01em}
        .asset-symbol{font-size:.8rem;color:var(--accent);opacity:.8;font-weight:600}
        .widget-price{position:relative;z-index:1;text-align:center;margin:16px 0}
        .price-value{font-size:2rem;font-weight:800;line-height:1;margin-bottom:6px;letter-spacing:-0.02em}
        .price-currency{font-size:.8rem;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:0.05em}
        .widget-chart{position:relative;z-index:1;height:80px;margin:16px 0}
        .chart-canvas{width:100%;height:100%;border-radius:8px}
        .widget-footer{position:relative;z-index:1}
        .timestamp{font-size:.7rem;color:var(--text2);margin-bottom:10px;text-align:center;opacity:.7}
        .branding{text-align:center;font-size:.75rem;color:var(--text2);opacity:.4;font-weight:600;text-transform:uppercase;letter-spacing:0.1em}
        .carousel-loading{width:260px;height:260px;background:var(--bg2);border-radius:16px;display:flex;align-items:center;justify-content:center;color:var(--text2);border:1px solid var(--border);font-size:.9rem;flex-shrink:0;text-align:center;padding:20px}
        .container{max-width:600px;margin:0 auto;animation:fadeIn 1s ease-out 0.6s backwards}
        .section-header{text-align:center;margin-bottom:20px}
        .section-title{font-size:1.5rem;font-weight:700;margin-bottom:6px;color:var(--text);letter-spacing:-0.01em}
        .section-subtitle{font-size:.9rem;color:var(--text2)}
        .input-section{background:linear-gradient(135deg,var(--bg2) 0%,rgba(21,21,31,0.8) 100%);padding:32px;border-radius:20px;margin-bottom:32px;border:1px solid var(--border);box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(10px);position:relative;overflow:hidden}
        .input-section::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0.3}
        .type-selector{display:flex;gap:12px;margin-bottom:20px}
        .type-btn{flex:1;padding:14px 20px;background:var(--bg3);border:2px solid var(--border);border-radius:12px;color:var(--text2);font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);text-transform:uppercase;letter-spacing:0.05em;position:relative;overflow:hidden}
        .type-btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:var(--accent);opacity:0.2;transform:translate(-50%,-50%);transition:width 0.4s,height 0.4s}
        .type-btn:hover::before{width:300px;height:300px}
        .type-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 4px 20px var(--glow)}
        .type-btn:hover:not(.active){border-color:var(--accent);transform:translateY(-2px)}
        .search-container{position:relative}
        .search-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:1.2rem;z-index:2;pointer-events:none}
        input[type="text"]{width:100%;padding:16px 20px 16px 52px;background:var(--bg3);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:1.05rem;transition:all 0.3s;font-weight:500}
        input[type="text"]:focus{outline:none;border-color:var(--accent);background:rgba(26,26,40,0.8);box-shadow:0 0 0 4px var(--glow)}
        input[type="text"]::placeholder{color:var(--text2);font-weight:400}
        .suggestions{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg3);border:2px solid var(--accent);border-radius:12px;max-height:320px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 12px 40px rgba(0,0,0,.5),0 0 0 1px var(--accent);animation:slideDown 0.3s ease-out}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .suggestions.active{display:block}
        .suggestion-item{padding:14px 20px 14px 52px;cursor:pointer;transition:all 0.2s;border-bottom:1px solid var(--border)}
        .suggestion-item:last-child{border-bottom:none}
        .suggestion-item:hover{background:linear-gradient(90deg,var(--accent) 0%,transparent 100%);background-size:200% 100%;animation:shimmer 2s infinite}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .suggestion-symbol{font-weight:700;color:var(--text);display:block;font-size:.95rem}
        .suggestion-name{font-size:.85rem;color:var(--text2);display:block;margin-top:2px}
        .widget-container{display:none;margin-bottom:32px}
        .widget-container.visible{display:block;animation:zoomIn 0.5s cubic-bezier(0.4,0,0.2,1)}
        @keyframes zoomIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        #priceWidget{width:100%;max-width:500px;height:500px;background:linear-gradient(135deg,var(--bg3) 0%,#252538 100%);border-radius:24px;padding:40px;display:flex;flex-direction:column;justify-content:space-between;border:2px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 0 1px rgba(91,124,255,0.1);margin:0 auto 20px;position:relative;overflow:hidden}
        #priceWidget::before{content:'';position:absolute;top:0;left:0;right:0;height:60%;background:radial-gradient(circle at 50% 0%,rgba(91,124,255,.08) 0%,transparent 70%);pointer-events:none}
        #priceWidget .widget-header{position:relative;z-index:1;display:flex;justify-content:space-between;align-items:flex-start}
        #priceWidget .widget-header-left{flex:1}
        #priceWidget .asset-name{font-size:1.4rem;font-weight:800;margin-bottom:6px;color:var(--text);letter-spacing:-0.02em}
        #priceWidget .asset-symbol{font-size:1rem;color:var(--accent);font-weight:700}
        #priceWidget .widget-price{position:relative;z-index:1;text-align:center;margin:24px 0}
        #priceWidget .price-value{font-size:3.5rem;font-weight:900;line-height:1;margin-bottom:10px;letter-spacing:-0.03em}
        #priceWidget .price-currency{font-size:1rem;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:0.1em}
        #priceWidget .widget-chart{position:relative;z-index:1;height:140px;margin:24px 0;border-radius:12px;overflow:hidden}
        #chartCanvas{width:100%;height:100%}
        #priceWidget .widget-footer{position:relative;z-index:1}
        #priceWidget .timestamp{font-size:.85rem;color:var(--text2);margin-bottom:16px;text-align:center;font-weight:500}
        #priceWidget .branding{text-align:center;font-size:.9rem;color:var(--text2);opacity:.5;font-weight:700;text-transform:uppercase;letter-spacing:0.15em}
        .chart-toggle{display:flex;gap:6px;background:var(--bg3);border-radius:8px;padding:4px;border:1px solid var(--border)}
        .chart-toggle-btn{padding:8px 14px;background:transparent;border:none;border-radius:6px;color:var(--text2);font-size:.75rem;font-weight:700;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:0.05em}
        .chart-toggle-btn.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px var(--glow)}
        .chart-toggle-btn:hover:not(.active){background:rgba(91,124,255,.15);color:var(--accent)}
        button{padding:16px 32px;background:linear-gradient(135deg,var(--accent) 0%,#8b5cf6 100%);color:#fff;border:none;border-radius:12px;font-size:1.05rem;font-weight:700;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);width:100%;text-transform:uppercase;letter-spacing:0.05em;box-shadow:0 4px 20px var(--glow)}
        button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 30px rgba(91,124,255,.4)}
        button:active:not(:disabled){transform:translateY(-1px)}
        button:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .export-btn{background:linear-gradient(135deg,var(--green) 0%,#16a34a 100%);display:flex;align-items:center;justify-content:center;gap:8px}
        .export-btn:hover:not(:disabled){box-shadow:0 8px 30px rgba(34,197,94,.4)}
        .error{background:rgba(239,68,68,.1);border:1px solid var(--red);border-radius:12px;padding:18px;margin-bottom:20px;color:var(--red);text-align:center;font-size:.95rem;font-weight:600}
        .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;display:inline-block}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media(max-width:600px){
            body{padding:12px}
            h1{font-size:2rem}
            .subtitle{font-size:.95rem}
            header{margin-bottom:24px;padding:24px 12px 12px}
            .input-section{padding:24px 20px}
            #priceWidget{height:auto;min-height:450px;padding:32px 28px}
            #priceWidget .price-value{font-size:2.8rem}
            .carousel-item{min-width:220px;max-width:220px}
            .carousel-widget{width:220px;height:220px;padding:20px}
            .carousel-widget .price-value{font-size:1.7rem}
            .carousel-loading{width:220px;height:220px}
        }
    </style>
</head>
<body>
    <header>
        <h1>Ticker Snapshot</h1>
        <p class="subtitle">Instant market prices, shareable as images</p>
    </header>
    <div class="carousel-container">
        <div class="carousel-wrapper" id="carouselWrapper"></div>
    </div>
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Generate Snapshot</h2>
            <p class="section-subtitle">Search any stock or cryptocurrency</p>
        </div>
        <div class="input-section">
            <div class="type-selector">
                <button class="type-btn active" data-type="stock">Stocks</button>
                <button class="type-btn" data-type="crypto">Crypto</button>
            </div>
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="symbolInput" placeholder="Search symbol..." autocomplete="off">
                <div class="suggestions" id="suggestions"></div>
            </div>
        </div>
        <div id="errorMessage" class="error" style="display:none"></div>
        <div class="widget-container" id="widgetContainer">
            <div id="priceWidget">
                <div class="widget-header">
                    <div class="widget-header-left">
                        <div class="asset-name" id="assetName">Loading...</div>
                        <div class="asset-symbol" id="assetSymbol"></div>
                    </div>
                    <div class="chart-toggle">
                        <button class="chart-toggle-btn active" data-chart="candle">Candle</button>
                        <button class="chart-toggle-btn" data-chart="line">Line</button>
                    </div>
                </div>
                <div class="widget-price">
                    <div class="price-value" id="priceValue">$0.00</div>
                    <div class="price-currency">USD</div>
                </div>
                <div class="widget-chart">
                    <canvas id="chartCanvas"></canvas>
                </div>
                <div class="widget-footer">
                    <div class="timestamp" id="timestamp">Snapshot taken: ---</div>
                    <div class="branding">Ticker Snapshot</div>
                </div>
            </div>
            <button id="exportBtn" class="export-btn"><span>üíæ</span><span>Save as Image</span></button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const state={currentSymbol:'',currentType:'stock',chartData:[],assetInfo:{},searchCache:new Map(),priceCache:new Map(),chartType:'candle'};
        const API={alphaVantageKey:'demo',coinGeckoBase:'https://api.coingecko.com/api/v3',cacheDuration:60000};
        // Load crypto first since it doesn't need API keys
        const CAROUSEL=[{symbol:'BTC',type:'crypto',name:'Bitcoin'},{symbol:'ETH',type:'crypto',name:'Ethereum'},{symbol:'SOL',type:'crypto',name:'Solana'},{symbol:'BNB',type:'crypto',name:'Binance Coin'}];
        const el={symbolInput:document.getElementById('symbolInput'),exportBtn:document.getElementById('exportBtn'),widgetContainer:document.getElementById('widgetContainer'),priceWidget:document.getElementById('priceWidget'),assetName:document.getElementById('assetName'),assetSymbol:document.getElementById('assetSymbol'),priceValue:document.getElementById('priceValue'),timestamp:document.getElementById('timestamp'),chartCanvas:document.getElementById('chartCanvas'),errorMessage:document.getElementById('errorMessage'),suggestions:document.getElementById('suggestions'),carouselWrapper:document.getElementById('carouselWrapper'),typeBtns:document.querySelectorAll('.type-btn'),chartToggleBtns:document.querySelectorAll('.chart-toggle-btn')};

```
    document.addEventListener('DOMContentLoaded',init);

    function init(){
        initCarousel();
        initSearch();
        initTypeSelector();
        initChartToggle();
        el.exportBtn.addEventListener('click',exportAsImage);
    }

    function initTypeSelector(){
        el.typeBtns.forEach(btn=>{
            btn.addEventListener('click',()=>{
                el.typeBtns.forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                state.currentType=btn.dataset.type;
                el.suggestions.classList.remove('active');
            });
        });
    }

    function initChartToggle(){
        el.chartToggleBtns.forEach(btn=>{
            btn.addEventListener('click',()=>{
                el.chartToggleBtns.forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                state.chartType=btn.dataset.chart;
                if(state.chartData&&state.chartData.length>0)drawChart(state.chartData);
            });
        });
    }

    async function initCarousel(){
        el.carouselWrapper.innerHTML=CAROUSEL.map(()=>'<div class="carousel-loading">Loading...</div>').join('');
        for(let i=0;i<CAROUSEL.length;i++){
            const item=CAROUSEL[i];
            try{
                const data=item.type==='crypto'?await fetchCryptoData(item.symbol):await fetchStockData(item.symbol);
                renderCarouselItem(data,item.type,i);
            }catch(error){
                console.error(`Failed ${item.symbol}:`,error);
                const loadingEl=el.carouselWrapper.children[i];
                if(loadingEl)loadingEl.innerHTML='<div class="carousel-loading">Failed to load<br>'+item.symbol+'</div>';
            }
            await sleep(800);
        }
    }

    function renderCarouselItem(data,type,index){
        const item=document.createElement('div');
        item.className='carousel-item';
        item.onclick=()=>{
            el.symbolInput.value=data.symbol;
            state.currentType=type;
            el.typeBtns.forEach(btn=>btn.classList.toggle('active',btn.dataset.type===type));
            generateSnapshot();
            window.scrollTo({top:0,behavior:'smooth'});
        };
        item.innerHTML=`<div class="carousel-widget"><div class="widget-header"><div class="asset-name">${data.name}</div><div class="asset-symbol">${data.symbol}</div></div><div class="widget-price"><div class="price-value">$${formatPrice(data.price)}</div><div class="price-currency">USD</div></div><div class="widget-chart"><canvas class="chart-canvas"></canvas></div><div class="widget-footer"><div class="timestamp">${formatTimestamp(new Date())}</div><div class="branding">Ticker Snapshot</div></div></div>`;
        el.carouselWrapper.children[index].replaceWith(item);
        drawChartOnCanvas(item.querySelector('.chart-canvas'),data.chartData,'candle');
    }

    let searchTimeout;
    function initSearch(){
        el.symbolInput.addEventListener('input',e=>{
            clearTimeout(searchTimeout);
            const query=e.target.value.trim();
            if(query.length<2){el.suggestions.classList.remove('active');return}
            searchTimeout=setTimeout(()=>performSearch(query),300);
        });
        el.symbolInput.addEventListener('focus',e=>{if(e.target.value.length>=2)performSearch(e.target.value)});
        el.symbolInput.addEventListener('keypress',e=>{if(e.key==='Enter'){const query=el.symbolInput.value.trim().toUpperCase();if(query){el.suggestions.classList.remove('active');generateSnapshot()}}});
        document.addEventListener('click',e=>{if(!el.symbolInput.contains(e.target)&&!el.suggestions.contains(e.target))el.suggestions.classList.remove('active')});
    }

    async function performSearch(query){
        const type=state.currentType;
        const cacheKey=`${type}-${query}`;
        if(state.searchCache.has(cacheKey)){displaySuggestions(state.searchCache.get(cacheKey));return}
        try{
            const results=type==='crypto'?await searchCrypto(query):await searchStock(query);
            state.searchCache.set(cacheKey,results);
            displaySuggestions(results);
        }catch(error){console.error('Search error:',error)}
    }

    async function searchCrypto(query){
        const url=`${API.coinGeckoBase}/search?query=${encodeURIComponent(query)}`;
        const response=await fetch(url);
        if(!response.ok)throw new Error('Search failed');
        const data=await response.json();
        return data.coins.slice(0,10).map(coin=>({symbol:coin.symbol.toUpperCase(),name:coin.name,id:coin.id}));
    }

    async function searchStock(query){
        const url=`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${encodeURIComponent(query)}&apikey=${API.alphaVantageKey}`;
        const response=await fetch(url);
        if(!response.ok)throw new Error('Search failed');
        const data=await response.json();
        if(data.bestMatches)return data.bestMatches.slice(0,10).map(match=>({symbol:match['1. symbol'],name:match['2. name']}));
        return[];
    }

    function displaySuggestions(results){
        if(!results||results.length===0){el.suggestions.classList.remove('active');return}
        el.suggestions.innerHTML=results.map(item=>`<div class="suggestion-item" onclick="selectSuggestion('${item.symbol.replace(/'/g,"\\'")}')"><span class="suggestion-symbol">${item.symbol}</span><span class="suggestion-name">${item.name}</span></div>`).join('');
        el.suggestions.classList.add('active');
    }

    function selectSuggestion(symbol){
        el.symbolInput.value=symbol;
        el.suggestions.classList.remove('active');
        generateSnapshot();
    }

    async function generateSnapshot(){
        const symbol=el.symbolInput.value.trim().toUpperCase();
        const type=state.currentType;
        if(!symbol){showError('Please enter a symbol');return}
        hideError();
        el.widgetContainer.classList.remove('visible');
        el.suggestions.classList.remove('active');
        try{
            state.currentSymbol=symbol;
            state.currentType=type;
            const data=type==='crypto'?await fetchCryptoData(symbol):await fetchStockData(symbol);
            updateWidget(data);
            el.widgetContainer.classList.add('visible');
        }catch(error){console.error('Error:',error);showError(error.message||'Failed to fetch data. Try another symbol.')}
    }

    async function fetchCryptoData(symbol){
        const cacheKey=`crypto-${symbol}`;
        const cached=state.priceCache.get(cacheKey);
        if(cached&&Date.now()-cached.timestamp<API.cacheDuration)return cached.data;
        const coinId=getCoinId(symbol);
        const priceUrl=`${API.coinGeckoBase}/simple/price?ids=${coinId}&vs_currencies=usd`;
        const priceResponse=await fetch(priceUrl);
        if(!priceResponse.ok)throw new Error('Crypto not found');
        const priceData=await priceResponse.json();
        const currentPrice=priceData[coinId]?.usd;
        if(!currentPrice)throw new Error('Price unavailable');
        const ohlcUrl=`${API.coinGeckoBase}/coins/${coinId}/ohlc?vs_currency=usd&days=1`;
        const ohlcResponse=await fetch(ohlcUrl);
        if(!ohlcResponse.ok)throw new Error('Chart data unavailable');
        const ohlcData=await ohlcResponse.json();
        const data={name:getCoinName(symbol),symbol:symbol,price:currentPrice,chartData:ohlcData.slice(-24)};
        state.priceCache.set(cacheKey,{data,timestamp:Date.now()});
        return data;
    }

    async function fetchStockData(symbol){
        const cacheKey=`stock-${symbol}`;
        const cached=state.priceCache.get(cacheKey);
        if(cached&&Date.now()-cached.timestamp<API.cacheDuration)return cached.data;
        const baseUrl='https://www.alphavantage.co/query';
        const quoteUrl=`${baseUrl}?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API.alphaVantageKey}`;
        const quoteResponse=await fetch(quoteUrl);
        if(!quoteResponse.ok)throw new Error('Stock API unavailable');
        const quoteData=await quoteResponse.json();
        if(quoteData['Error Message']||quoteData['Note'])throw new Error('Stock not found or API limit reached');
        const quote=quoteData['Global Quote'];
        if(!quote||!quote['05. price'])throw new Error('Stock data unavailable');
        const intradayUrl=`${baseUrl}?function=TIME_SERIES_INTRADAY&symbol=${symbol}&interval=30min&apikey=${API.alphaVantageKey}`;
        const intradayResponse=await fetch(intradayUrl);
        const intradayData=await intradayResponse.json();
        const timeSeries=intradayData['Time Series (30min)']||{};
        const chartData=Object.entries(timeSeries).slice(0,12).reverse().map(([time,values])=>[new Date(time).getTime(),parseFloat(values['1. open']),parseFloat(values['2. high']),parseFloat(values['3. low']),parseFloat(values['4. close'])]);
        const data={name:symbol,symbol:symbol,price:parseFloat(quote['05. price']),chartData:chartData};
        state.priceCache.set(cacheKey,{data,timestamp:Date.now()});
        return data;
    }

    function updateWidget(data){
        state.assetInfo=data;
        state.chartData=data.chartData;
        el.assetName.textContent=data.name;
        el.assetSymbol.textContent=data.symbol;
        el.priceValue.textContent=`$${formatPrice(data.price)}`;
        el.timestamp.textContent=`Snapshot taken: ${formatTimestamp(new Date())}`;
        drawChart(data.chartData);
    }

    function drawChart(data){drawChartOnCanvas(el.chartCanvas,data,state.chartType)}

    function drawChartOnCanvas(canvas,data,chartType='candle'){
        const ctx=canvas.getContext('2d',{alpha:true});
        const rect=canvas.getBoundingClientRect();
        const dpr=window.devicePixelRatio||1;
        canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
        ctx.scale(dpr,dpr);
        const width=rect.width,height=rect.height;
        ctx.clearRect(0,0,width,height);
        if(!data||data.length===0){ctx.fillStyle='#a0a0b0';ctx.font='14px sans-serif';ctx.textAlign='center';ctx.fillText('Chart unavailable',width/2,height/2);return}
        const prices=data.map(d=>({open:d[1],high:d[2],low:d[3],close:d[4]}));
        const allPrices=prices.flatMap(p=>[p.high,p.low]);
        const minPrice=Math.min(...allPrices),maxPrice=Math.max(...allPrices),priceRange=maxPrice-minPrice;
        const padding={top:10,bottom:10,left:10,right:10};
        const chartWidth=width-padding.left-padding.right,chartHeight=height-padding.top-padding.bottom;
        if(chartType==='line'){
            ctx.strokeStyle='#5b7cff';ctx.lineWidth=3;ctx.lineJoin='round';ctx.beginPath();
            prices.forEach((price,i)=>{
                const x=padding.left+(i/(prices.length-1))*chartWidth;
                const y=padding.top+((maxPrice-price.close)/priceRange)*chartHeight;
                i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
            });
            ctx.stroke();
            ctx.lineTo(width-padding.right,height-padding.bottom);
            ctx.lineTo(padding.left,height-padding.bottom);
            ctx.closePath();
            const gradient=ctx.createLinearGradient(0,padding.top,0,height-padding.bottom);
            gradient.addColorStop(0,'rgba(91,124,255,0.3)');gradient.addColorStop(1,'rgba(91,124,255,0)');
            ctx.fillStyle=gradient;ctx.fill();
        }else{
            const candleWidth=Math.max(3,Math.floor(chartWidth/prices.length)-3);
            const spacing=chartWidth/prices.length;
            prices.forEach((price,i)=>{
                const x=padding.left+(i*spacing)+(spacing/2);
                const yHigh=padding.top+((maxPrice-price.high)/priceRange)*chartHeight;
                const yLow=padding.top+((maxPrice-price.low)/priceRange)*chartHeight;
                const yOpen=padding.top+((maxPrice-price.open)/priceRange)*chartHeight;
                const yClose=padding.top+((maxPrice-price.close)/priceRange)*chartHeight;
                const isUp=price.close>=price.open;
                ctx.strokeStyle=isUp?'#22c55e':'#ef4444';ctx.fillStyle=isUp?'#22c55e':'#ef4444';
                ctx.beginPath();ctx.moveTo(x,yHigh);ctx.lineTo(x,yLow);ctx.lineWidth=2;ctx.stroke();
                const bodyTop=Math.min(yOpen,yClose),bodyHeight=Math.abs(yClose-yOpen);
                if(bodyHeight<2){ctx.beginPath();ctx.moveTo(x-candleWidth/2,bodyTop);ctx.lineTo(x+candleWidth/2,bodyTop);ctx.lineWidth=2;ctx.stroke()}
                else ctx.fillRect(x-candleWidth/2,bodyTop,candleWidth,bodyHeight);
            });
        }
    }

    async function exportAsImage(){
        if(!window.html2canvas){showError('Export library not loaded. Refresh page.');return}
        el.exportBtn.disabled=true;el.exportBtn.innerHTML='<span class="spinner"></span><span>Saving...</span>';
        try{
            const canvas=await html2canvas(el.priceWidget,{backgroundColor:null,scale:2,logging:false,useCORS:true});
            canvas.toBlob(blob=>{
                const url=URL.createObjectURL(blob);
                const link=document.createElement('a');
                link.href=url;link.download=`ticker-${state.currentSymbol}-${formatDateForFilename()}.png`;
                link.click();URL.revokeObjectURL(url);
                el.exportBtn.disabled=false;el.exportBtn.innerHTML='<span>üíæ</span><span>Save as Image</span>';
            },'image/png',0.95);
        }catch(error){console.error('Export error:',error);showError('Export failed. Try again.');el.exportBtn.disabled=false;el.exportBtn.innerHTML='<span>üíæ</span><span>Save as Image</span>'}
    }

    function formatPrice(price){
        if(price>=1)return price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        if(price>=0.01)return price.toLocaleString('en-US',{minimumFractionDigits:4,maximumFractionDigits:4});
        return price.toLocaleString('en-US',{minimumFractionDigits:6,maximumFractionDigits:6});
    }
    function formatTimestamp(date){
        const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const month=months[date.getMonth()],day=date.getDate(),year=date.getFullYear();
        let hours=date.getHours();
        const minutes=date.getMinutes().toString().padStart(2,'0'),ampm=hours>=12?'PM':'AM';
        hours=hours%12||12;
        return`${month} ${day}, ${year} ¬∑ ${hours}:${minutes} ${ampm} EST`;
    }
    function formatDateForFilename(){
        const date=new Date(),year=date.getFullYear();
        const month=(date.getMonth()+1).toString().padStart(2,'0'),day=date.getDate().toString().padStart(2,'0');
        return`${year}-${month}-${day}`;
    }
    function getCoinId(symbol){
        const map={'BTC':'bitcoin','ETH':'ethereum','USDT':'tether','BNB':'binancecoin','SOL':'solana','XRP':'ripple','USDC':'usd-coin','ADA':'cardano','DOGE':'dogecoin','AVAX':'avalanche-2','DOT':'polkadot','MATIC':'matic-network','LINK':'chainlink','UNI':'uniswap','ATOM':'cosmos'};
        return map[symbol]||symbol.toLowerCase();
    }
    function getCoinName(symbol){
        const map={'BTC':'Bitcoin','ETH':'Ethereum','USDT':'Tether','BNB':'Binance Coin','SOL':'Solana','XRP':'Ripple','USDC':'USD Coin','ADA':'Cardano','DOGE':'Dogecoin','AVAX':'Avalanche','DOT':'Polkadot','MATIC':'Polygon','LINK':'Chainlink','UNI':'Uniswap','ATOM':'Cosmos'};
        return map[symbol]||symbol;
    }
    function showError(message){el.errorMessage.textContent=message;el.errorMessage.style.display='block'}
    function hideError(){el.errorMessage.style.display='none'}
    function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}
</script>
```

</body>
</html>
