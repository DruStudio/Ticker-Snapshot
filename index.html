<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker Snapshot</title>
    <link rel="preconnect" href="https://api.coingecko.com">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0f;--bg2:#15151f;--bg3:#1a1a28;--text:#fff;--text2:#a0a0b0;--accent:#5b7cff;--accent2:#4a6aee;--green:#22c55e;--red:#ef4444;--border:#2a2a3a;--glow:rgba(91,124,255,0.15)}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;padding:16px;background-image:radial-gradient(circle at 20% 50%,rgba(91,124,255,0.05) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(139,92,246,0.05) 0%,transparent 50%)}
        header{text-align:center;margin-bottom:32px;padding:32px 16px 16px}
        h1{font-size:2.5rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#5b7cff 0%,#8b5cf6 50%,#ec4899 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.02em}
        .subtitle{color:var(--text2);font-size:1.1rem}
        .carousel-container{max-width:1200px;margin:0 auto 48px}
        .carousel-wrapper{display:flex;gap:20px;overflow-x:auto;scroll-behavior:smooth;padding:16px 8px 24px;scrollbar-width:thin;scrollbar-color:var(--accent) transparent;scroll-snap-type:x mandatory}
        .carousel-wrapper::-webkit-scrollbar{height:8px}
        .carousel-wrapper::-webkit-scrollbar-track{background:transparent}
        .carousel-wrapper::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}
        .carousel-item{min-width:260px;max-width:260px;flex-shrink:0;cursor:pointer;transition:all 0.3s;scroll-snap-align:start}
        .carousel-item:hover{transform:translateY(-8px) scale(1.02)}
        .carousel-widget{width:260px;height:260px;background:linear-gradient(135deg,var(--bg3) 0%,#252538 100%);border-radius:16px;padding:24px;display:flex;flex-direction:column;justify-content:space-between;border:1px solid var(--border);box-shadow:0 8px 32px rgba(0,0,0,.4);position:relative;overflow:hidden}
        .carousel-widget::before{content:'';position:absolute;top:0;left:0;right:0;height:60%;background:radial-gradient(circle at 50% 0%,rgba(91,124,255,.08) 0%,transparent 70%);pointer-events:none}
        .carousel-item:hover .carousel-widget{border-color:var(--accent);box-shadow:0 12px 48px rgba(0,0,0,.5),0 0 0 1px var(--accent)}
        .widget-header{position:relative;z-index:1}
        .asset-name{font-size:1rem;font-weight:700;margin-bottom:3px;color:var(--text)}
        .asset-symbol{font-size:.8rem;color:var(--accent);font-weight:600}
        .widget-price{position:relative;z-index:1;text-align:center;margin:16px 0}
        .price-value{font-size:2rem;font-weight:800;line-height:1;margin-bottom:6px}
        .price-currency{font-size:.8rem;color:var(--text2);font-weight:600;text-transform:uppercase}
        .widget-chart{position:relative;z-index:1;height:80px;margin:16px 0}
        .chart-canvas{width:100%;height:100%;border-radius:8px}
        .widget-footer{position:relative;z-index:1}
        .timestamp{font-size:.7rem;color:var(--text2);margin-bottom:10px;text-align:center;opacity:.7}
        .branding{text-align:center;font-size:.75rem;color:var(--text2);opacity:.4;font-weight:600}
        .carousel-loading{width:260px;height:260px;background:var(--bg2);border-radius:16px;display:flex;align-items:center;justify-content:center;color:var(--text2);border:1px solid var(--border);font-size:.9rem;flex-shrink:0}
        .container{max-width:600px;margin:0 auto}
        .section-header{text-align:center;margin-bottom:20px}
        .section-title{font-size:1.5rem;font-weight:700;margin-bottom:6px;color:var(--text);letter-spacing:-0.01em}
        .section-subtitle{font-size:.9rem;color:var(--text2)}
        .input-section{background:linear-gradient(135deg,var(--bg2) 0%,rgba(21,21,31,0.8) 100%);padding:32px;border-radius:20px;margin-bottom:32px;border:1px solid var(--border);box-shadow:0 8px 32px rgba(0,0,0,.3)}
        .type-selector{display:flex;gap:12px;margin-bottom:20px}
        .type-btn{flex:1;padding:14px 20px;background:transparent;border:2px solid var(--border);border-radius:12px;color:var(--text2);font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:0.05em}
        .type-btn.active{background:transparent;border-color:var(--accent);color:var(--accent);box-shadow:0 0 20px var(--glow),inset 0 0 20px rgba(91,124,255,0.1)}
        .type-btn:hover:not(.active){border-color:var(--accent);transform:translateY(-2px)}
        .search-container{position:relative}
        .search-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:1.2rem;z-index:2;pointer-events:none}
        input[type="text"]{width:100%;padding:16px 20px 16px 52px;background:var(--bg3);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:1.05rem;transition:all 0.3s;font-weight:500}
        input[type="text"]:focus{outline:none;border-color:var(--accent);background:rgba(26,26,40,0.8);box-shadow:0 0 0 4px var(--glow)}
        input[type="text"]::placeholder{color:var(--text2);font-weight:400}
        .suggestions{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg3);border:2px solid var(--accent);border-radius:12px;max-height:320px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 12px 40px rgba(0,0,0,.5)}
        .suggestions.active{display:block}
        .suggestion-item{padding:14px 20px 14px 52px;cursor:pointer;transition:all 0.2s;border-bottom:1px solid var(--border)}
        .suggestion-item:last-child{border-bottom:none}
        .suggestion-item:hover{background:rgba(91,124,255,0.15)}
        .suggestion-symbol{font-weight:700;color:var(--text);display:block;font-size:.95rem}
        .suggestion-name{font-size:.85rem;color:var(--text2);display:block;margin-top:2px}
        .widget-container{display:none;margin-bottom:32px}
        .widget-container.visible{display:block}
        #priceWidget{width:100%;max-width:500px;height:500px;background:linear-gradient(135deg,var(--bg3) 0%,#252538 100%);border-radius:24px;padding:40px;display:flex;flex-direction:column;justify-content:space-between;border:2px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.5);margin:0 auto 20px;position:relative}
        #priceWidget .widget-header{position:relative;z-index:1;display:flex;justify-content:space-between;align-items:flex-start}
        #priceWidget .widget-header-left{flex:1}
        #priceWidget .asset-name{font-size:1.4rem;font-weight:800;margin-bottom:6px;color:var(--text)}
        #priceWidget .asset-symbol{font-size:1rem;color:var(--accent);font-weight:700}
        #priceWidget .widget-price{text-align:center;margin:24px 0}
        #priceWidget .price-value{font-size:3.5rem;font-weight:900;line-height:1;margin-bottom:10px}
        #priceWidget .price-currency{font-size:1rem;color:var(--text2);font-weight:700}
        #priceWidget .widget-chart{height:140px;margin:24px 0}
        #chartCanvas{width:100%;height:100%}
        #priceWidget .timestamp{font-size:.85rem;color:var(--text2);text-align:center;margin-bottom:16px}
        #priceWidget .branding{text-align:center;font-size:.9rem;color:var(--text2);opacity:.5}
        .chart-toggle{display:flex;gap:6px;background:var(--bg3);border-radius:8px;padding:4px;border:1px solid var(--border)}
        .chart-toggle-btn{padding:8px 14px;background:transparent;border:none;border-radius:6px;color:var(--text2);font-size:.75rem;font-weight:700;cursor:pointer;transition:all 0.3s;text-transform:uppercase}
        .chart-toggle-btn.active{background:var(--accent);color:#fff}
        button{padding:16px 32px;background:linear-gradient(135deg,var(--accent) 0%,#8b5cf6 100%);color:#fff;border:none;border-radius:12px;font-size:1.05rem;font-weight:700;cursor:pointer;transition:all 0.3s;width:100%;text-transform:uppercase}
        button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 30px rgba(91,124,255,.4)}
        button:disabled{opacity:.5;cursor:not-allowed}
        .export-btn{background:linear-gradient(135deg,var(--green) 0%,#16a34a 100%);display:flex;align-items:center;justify-content:center;gap:8px}
        .error{background:rgba(239,68,68,.1);border:1px solid var(--red);border-radius:12px;padding:18px;margin-bottom:20px;color:var(--red);text-align:center;font-weight:600}
        .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;display:inline-block}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media(max-width:600px){
            h1{font-size:2rem}
            #priceWidget{height:auto;min-height:450px;padding:32px 28px}
            #priceWidget .price-value{font-size:2.8rem}
        }
    </style>
</head>
<body>
    <header>
        <h1>Ticker Snapshot</h1>
        <p class="subtitle">Instant market prices, shareable as images</p>
    </header>
    <div class="carousel-container">
        <div class="carousel-wrapper" id="carouselWrapper"></div>
    </div>
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Generate Snapshot</h2>
            <p class="section-subtitle">Search any stock or cryptocurrency</p>
        </div>
        <div class="input-section">
            <div class="type-selector">
                <button class="type-btn active" data-type="stock">Stocks</button>
                <button class="type-btn" data-type="crypto">Crypto</button>
            </div>
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="symbolInput" placeholder="Try: AAPL, BTC, TSLA, ETH..." autocomplete="off">
                <div class="suggestions" id="suggestions"></div>
            </div>
        </div>
        <div id="errorMessage" class="error" style="display:none"></div>
        <div class="widget-container" id="widgetContainer">
            <div id="priceWidget">
                <div class="widget-header">
                    <div class="widget-header-left">
                        <div class="asset-name" id="assetName">Loading...</div>
                        <div class="asset-symbol" id="assetSymbol"></div>
                    </div>
                    <div class="chart-toggle">
                        <button class="chart-toggle-btn active" data-chart="candle">Candle</button>
                        <button class="chart-toggle-btn" data-chart="line">Line</button>
                    </div>
                </div>
                <div class="widget-price">
                    <div class="price-value" id="priceValue">$0.00</div>
                    <div class="price-currency">USD</div>
                </div>
                <div class="widget-chart">
                    <canvas id="chartCanvas"></canvas>
                </div>
                <div class="widget-footer">
                    <div class="timestamp" id="timestamp">Snapshot taken: ---</div>
                    <div class="branding">TICKER SNAPSHOT</div>
                </div>
            </div>
            <button id="exportBtn" class="export-btn"><span>üíæ</span><span>Save as Image</span></button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const state={currentSymbol:'',currentType:'stock',chartData:[],chartType:'candle',searchCache:new Map(),priceCache:new Map()};
        const API={alphaVantageKey:'demo',coinGeckoBase:'https://api.coingecko.com/api/v3',cacheDuration:60000};
        const CAROUSEL=[{symbol:'BTC',type:'crypto',name:'Bitcoin'},{symbol:'ETH',type:'crypto',name:'Ethereum'},{symbol:'SOL',type:'crypto',name:'Solana'},{symbol:'BNB',type:'crypto',name:'Binance'}];
        const el={symbolInput:document.getElementById('symbolInput'),exportBtn:document.getElementById('exportBtn'),widgetContainer:document.getElementById('widgetContainer'),priceWidget:document.getElementById('priceWidget'),assetName:document.getElementById('assetName'),assetSymbol:document.getElementById('assetSymbol'),priceValue:document.getElementById('priceValue'),timestamp:document.getElementById('timestamp'),chartCanvas:document.getElementById('chartCanvas'),errorMessage:document.getElementById('errorMessage'),suggestions:document.getElementById('suggestions'),carouselWrapper:document.getElementById('carouselWrapper'),typeBtns:document.querySelectorAll('.type-btn'),chartToggleBtns:document.querySelectorAll('.chart-toggle-btn')};

```
    document.addEventListener('DOMContentLoaded',()=>{
        console.log('Initializing...');
        initCarousel();
        el.typeBtns.forEach(btn=>btn.addEventListener('click',()=>{el.typeBtns.forEach(b=>b.classList.remove('active'));btn.classList.add('active');state.currentType=btn.dataset.type;el.suggestions.classList.remove('active')}));
        el.chartToggleBtns.forEach(btn=>btn.addEventListener('click',()=>{el.chartToggleBtns.forEach(b=>b.classList.remove('active'));btn.classList.add('active');state.chartType=btn.dataset.chart;if(state.chartData?.length>0)drawChart(state.chartData)}));
        let searchTimeout;
        el.symbolInput.addEventListener('input',e=>{clearTimeout(searchTimeout);const query=e.target.value.trim();if(query.length<2){el.suggestions.classList.remove('active');return}searchTimeout=setTimeout(()=>performSearch(query),300)});
        el.symbolInput.addEventListener('focus',e=>{if(e.target.value.length>=2)performSearch(e.target.value)});
        el.symbolInput.addEventListener('keypress',e=>{if(e.key==='Enter'&&el.symbolInput.value.trim()){el.suggestions.classList.remove('active');generateSnapshot()}});
        document.addEventListener('click',e=>{if(!el.symbolInput.contains(e.target)&&!el.suggestions.contains(e.target))el.suggestions.classList.remove('active')});
        el.exportBtn.addEventListener('click',exportAsImage);
    });
    
    async function initCarousel(){
        console.log('Loading carousel...');
        el.carouselWrapper.innerHTML=CAROUSEL.map(()=>'<div class="carousel-loading">Loading...</div>').join('');
        for(let i=0;i<CAROUSEL.length;i++){
            const item=CAROUSEL[i];
            try{
                console.log('Loading',item.symbol);
                const data=await fetchCryptoData(item.symbol);
                renderCarouselItem(data,i);
            }catch(error){
                console.error(`Failed ${item.symbol}:`,error);
                if(el.carouselWrapper.children[i])el.carouselWrapper.children[i].innerHTML='<div class="carousel-loading">Failed<br>'+item.symbol+'</div>';
            }
            await sleep(500);
        }
    }
    
    function renderCarouselItem(data,index){
        const item=document.createElement('div');
        item.className='carousel-item';
        item.onclick=()=>{
            el.symbolInput.value=data.symbol;
            state.currentType='crypto';
            el.typeBtns.forEach(btn=>btn.classList.toggle('active',btn.dataset.type==='crypto'));
            generateSnapshot();
            window.scrollTo({top:0,behavior:'smooth'});
        };
        item.innerHTML=`<div class="carousel-widget"><div class="widget-header"><div class="asset-name">${data.name}</div><div class="asset-symbol">${data.symbol}</div></div><div class="widget-price"><div class="price-value">$${formatPrice(data.price)}</div><div class="price-currency">USD</div></div><div class="widget-chart"><canvas class="chart-canvas"></canvas></div><div class="widget-footer"><div class="timestamp">${formatTimestamp(new Date())}</div><div class="branding">TICKER SNAPSHOT</div></div></div>`;
        if(el.carouselWrapper.children[index])el.carouselWrapper.children[index].replaceWith(item);
        drawChartOnCanvas(item.querySelector('.chart-canvas'),data.chartData);
    }
    
    function drawChartOnCanvas(canvas,data){
        const ctx=canvas.getContext('2d'),rect=canvas.getBoundingClientRect(),dpr=window.devicePixelRatio||1;
        canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;ctx.scale(dpr,dpr);
        const width=rect.width,height=rect.height;ctx.clearRect(0,0,width,height);
        if(!data?.length)return;
        const prices=data.map(d=>({close:d[4]}));
        const allPrices=prices.map(p=>p.close);
        const minPrice=Math.min(...allPrices),maxPrice=Math.max(...allPrices),priceRange=maxPrice-minPrice;
        const padding=10;
        ctx.strokeStyle='#5b7cff';ctx.lineWidth=2;ctx.beginPath();
        prices.forEach((price,i)=>{
            const x=padding+(i/(prices.length-1))*(width-padding*2);
            const y=padding+((maxPrice-price.close)/priceRange)*(height-padding*2);
            i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        });
        ctx.stroke();
    }
    
    function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
    
    async function performSearch(query){
        const type=state.currentType,cacheKey=`${type}-${query}`;
        console.log('Searching:',type,query);
        if(state.searchCache.has(cacheKey)){displaySuggestions(state.searchCache.get(cacheKey));return}
        try{
            const results=type==='crypto'?await searchCrypto(query):await searchStock(query);
            console.log('Results:',results);
            state.searchCache.set(cacheKey,results);
            displaySuggestions(results);
        }catch(error){console.error('Search error:',error);showError('Search failed: '+error.message)}
    }
    
    async function searchCrypto(query){
        console.log('Searching crypto...');
        const response=await fetch(`${API.coinGeckoBase}/search?query=${encodeURIComponent(query)}`);
        console.log('Crypto response status:',response.status);
        if(!response.ok)throw new Error('Search failed');
        const data=await response.json();
        console.log('Crypto data:',data);
        return data.coins.slice(0,10).map(coin=>({symbol:coin.symbol.toUpperCase(),name:coin.name}));
    }
    
    async function searchStock(query){
        console.log('Searching stocks...');
        const response=await fetch(`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${encodeURIComponent(query)}&apikey=${API.alphaVantageKey}`);
        console.log('Stock response status:',response.status);
        if(!response.ok)throw new Error('Search failed');
        const data=await response.json();
        console.log('Stock data:',data);
        return data.bestMatches?data.bestMatches.slice(0,10).map(m=>({symbol:m['1. symbol'],name:m['2. name']})):[];
    }
    
    function displaySuggestions(results){
        if(!results||!results.length){el.suggestions.classList.remove('active');return}
        el.suggestions.innerHTML=results.map(item=>`<div class="suggestion-item" onclick="selectSuggestion('${item.symbol.replace(/'/g,"\\'")}')"><span class="suggestion-symbol">${item.symbol}</span><span class="suggestion-name">${item.name}</span></div>`).join('');
        el.suggestions.classList.add('active');
    }
    
    function selectSuggestion(symbol){el.symbolInput.value=symbol;el.suggestions.classList.remove('active');generateSnapshot()}
    
    async function generateSnapshot(){
        const symbol=el.symbolInput.value.trim().toUpperCase(),type=state.currentType;
        if(!symbol){showError('Please enter a symbol');return}
        hideError();el.widgetContainer.classList.remove('visible');el.suggestions.classList.remove('active');
        try{
            state.currentSymbol=symbol;
            const data=type==='crypto'?await fetchCryptoData(symbol):await fetchStockData(symbol);
            updateWidget(data);
            el.widgetContainer.classList.add('visible');
        }catch(error){showError(error.message||'Failed to fetch data')}
    }
    
    async function fetchCryptoData(symbol){
        const cacheKey=`crypto-${symbol}`,cached=state.priceCache.get(cacheKey);
        if(cached&&Date.now()-cached.timestamp<API.cacheDuration)return cached.data;
        const coinId=getCoinId(symbol);
        const priceRes=await fetch(`${API.coinGeckoBase}/simple/price?ids=${coinId}&vs_currencies=usd`);
        if(!priceRes.ok)throw new Error('Crypto not found');
        const priceData=await priceRes.json(),currentPrice=priceData[coinId]?.usd;
        if(!currentPrice)throw new Error('Price unavailable');
        const ohlcRes=await fetch(`${API.coinGeckoBase}/coins/${coinId}/ohlc?vs_currency=usd&days=1`);
        const ohlcData=await ohlcRes.json();
        const data={name:getCoinName(symbol),symbol,price:currentPrice,chartData:ohlcData.slice(-24)};
        state.priceCache.set(cacheKey,{data,timestamp:Date.now()});
        return data;
    }
    
    async function fetchStockData(symbol){
        const cacheKey=`stock-${symbol}`,cached=state.priceCache.get(cacheKey);
        if(cached&&Date.now()-cached.timestamp<API.cacheDuration)return cached.data;
        const quoteRes=await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API.alphaVantageKey}`);
        const quoteData=await quoteRes.json();
        if(quoteData['Error Message']||quoteData['Note'])throw new Error('Stock not found or API limit');
        const quote=quoteData['Global Quote'];
        if(!quote?.['05. price'])throw new Error('Stock data unavailable');
        const intradayRes=await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${symbol}&interval=30min&apikey=${API.alphaVantageKey}`);
        const intradayData=await intradayRes.json();
        const timeSeries=intradayData['Time Series (30min)']||{};
        const chartData=Object.entries(timeSeries).slice(0,12).reverse().map(([time,values])=>[Date.parse(time),parseFloat(values['1. open']),parseFloat(values['2. high']),parseFloat(values['3. low']),parseFloat(values['4. close'])]);
        const data={name:symbol,symbol,price:parseFloat(quote['05. price']),chartData};
        state.priceCache.set(cacheKey,{data,timestamp:Date.now()});
        return data;
    }
    
    function updateWidget(data){
        state.chartData=data.chartData;
        el.assetName.textContent=data.name;
        el.assetSymbol.textContent=data.symbol;
        el.priceValue.textContent=`$${formatPrice(data.price)}`;
        el.timestamp.textContent=`Snapshot taken: ${formatTimestamp(new Date())}`;
        drawChart(data.chartData);
    }
    
    function drawChart(data){
        const canvas=el.chartCanvas,ctx=canvas.getContext('2d'),rect=canvas.getBoundingClientRect(),dpr=window.devicePixelRatio||1;
        canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;ctx.scale(dpr,dpr);
        const width=rect.width,height=rect.height;ctx.clearRect(0,0,width,height);
        if(!data?.length){ctx.fillStyle='#a0a0b0';ctx.font='14px sans-serif';ctx.textAlign='center';ctx.fillText('Chart unavailable',width/2,height/2);return}
        const prices=data.map(d=>({open:d[1],high:d[2],low:d[3],close:d[4]}));
        const allPrices=prices.flatMap(p=>[p.high,p.low]);
        const minPrice=Math.min(...allPrices),maxPrice=Math.max(...allPrices),priceRange=maxPrice-minPrice;
        const padding={top:10,bottom:10,left:10,right:10};
        const chartWidth=width-padding.left-padding.right,chartHeight=height-padding.top-padding.bottom;
        if(state.chartType==='line'){
            ctx.strokeStyle='#5b7cff';ctx.lineWidth=3;ctx.beginPath();
            prices.forEach((price,i)=>{
                const x=padding.left+(i/(prices.length-1))*chartWidth;
                const y=padding.top+((maxPrice-price.close)/priceRange)*chartHeight;
                i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
            });
            ctx.stroke();
            ctx.lineTo(width-padding.right,height-padding.bottom);
            ctx.lineTo(padding.left,height-padding.bottom);
            ctx.closePath();
            const gradient=ctx.createLinearGradient(0,padding.top,0,height-padding.bottom);
            gradient.addColorStop(0,'rgba(91,124,255,0.3)');gradient.addColorStop(1,'rgba(91,124,255,0)');
            ctx.fillStyle=gradient;ctx.fill();
        }else{
            const candleWidth=Math.max(3,Math.floor(chartWidth/prices.length)-3);
            const spacing=chartWidth/prices.length;
            prices.forEach((price,i)=>{
                const x=padding.left+(i*spacing)+(spacing/2);
                const yHigh=padding.top+((maxPrice-price.high)/priceRange)*chartHeight;
                const yLow=padding.top+((maxPrice-price.low)/priceRange)*chartHeight;
                const yOpen=padding.top+((maxPrice-price.open)/priceRange)*chartHeight;
                const yClose=padding.top+((maxPrice-price.close)/priceRange)*chartHeight;
                const isUp=price.close>=price.open;
                ctx.strokeStyle=isUp?'#22c55e':'#ef4444';ctx.fillStyle=isUp?'#22c55e':'#ef4444';
                ctx.beginPath();ctx.moveTo(x,yHigh);ctx.lineTo(x,yLow);ctx.lineWidth=2;ctx.stroke();
                const bodyTop=Math.min(yOpen,yClose),bodyHeight=Math.abs(yClose-yOpen);
                if(bodyHeight<2){ctx.beginPath();ctx.moveTo(x-candleWidth/2,bodyTop);ctx.lineTo(x+candleWidth/2,bodyTop);ctx.lineWidth=2;ctx.stroke()}
                else ctx.fillRect(x-candleWidth/2,bodyTop,candleWidth,bodyHeight);
            });
        }
    }
    
    async function exportAsImage(){
        if(!window.html2canvas){showError('Export unavailable');return}
        el.exportBtn.disabled=true;el.exportBtn.innerHTML='<span class="spinner"></span><span>Saving...</span>';
        try{
            const canvas=await html2canvas(el.priceWidget,{backgroundColor:null,scale:2,logging:false});
            canvas.toBlob(blob=>{
                const url=URL.createObjectURL(blob),link=document.createElement('a');
                link.href=url;link.download=`ticker-${state.currentSymbol}-${formatDateForFilename()}.png`;
                link.click();URL.revokeObjectURL(url);
                el.exportBtn.disabled=false;el.exportBtn.innerHTML='<span>üíæ</span><span>Save as Image</span>';
            });
        }catch(error){showError('Export failed');el.exportBtn.disabled=false;el.exportBtn.innerHTML='<span>üíæ</span><span>Save as Image</span>'}
    }
    
    function formatPrice(price){
        if(price>=1)return price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        if(price>=0.01)return price.toLocaleString('en-US',{minimumFractionDigits:4,maximumFractionDigits:4});
        return price.toLocaleString('en-US',{minimumFractionDigits:6,maximumFractionDigits:6});
    }
    function formatTimestamp(date){
        const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        let hours=date.getHours();
        const minutes=date.getMinutes().toString().padStart(2,'0'),ampm=hours>=12?'PM':'AM';
        hours=hours%12||12;
        return`${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()} ¬∑ ${hours}:${minutes} ${ampm} EST`;
    }
    function formatDateForFilename(){
        const date=new Date();
        return`${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
    }
    function getCoinId(symbol){
        const map={'BTC':'bitcoin','ETH':'ethereum','USDT':'tether','BNB':'binancecoin','SOL':'solana','XRP':'ripple','USDC':'usd-coin','ADA':'cardano','DOGE':'dogecoin','AVAX':'avalanche-2','DOT':'polkadot','MATIC':'matic-network','LINK':'chainlink','UNI':'uniswap','ATOM':'cosmos'};
        return map[symbol]||symbol.toLowerCase();
    }
    function getCoinName(symbol){
        const map={'BTC':'Bitcoin','ETH':'Ethereum','USDT':'Tether','BNB':'Binance Coin','SOL':'Solana','XRP':'Ripple','USDC':'USD Coin','ADA':'Cardano','DOGE':'Dogecoin','AVAX':'Avalanche','DOT':'Polkadot','MATIC':'Polygon','LINK':'Chainlink','UNI':'Uniswap','ATOM':'Cosmos'};
        return map[symbol]||symbol;
    }
    function showError(message){el.errorMessage.textContent=message;el.errorMessage.style.display='block'}
    function hideError(){el.errorMessage.style.display='none'}
</script>
```

</body>
</html>
